From a8d68d7c9767c7efa7cfbe23611d1cedcf7aefe6 Mon Sep 17 00:00:00 2001
From: He Junyan <junyan.he@intel.com>
Date: Fri, 12 Apr 2024 16:09:26 +0800
Subject: [PATCH 08/24] examples: vaenc-dynamic: support force key frame
 setting

---
 .../examples/va/vaenc-dynamic-reconfigure.c   | 25 ++++++++++++++++---
 1 file changed, 22 insertions(+), 3 deletions(-)

diff --git a/subprojects/gst-plugins-bad/tests/examples/va/vaenc-dynamic-reconfigure.c b/subprojects/gst-plugins-bad/tests/examples/va/vaenc-dynamic-reconfigure.c
index 6ec2ffd387..562a6d177c 100644
--- a/subprojects/gst-plugins-bad/tests/examples/va/vaenc-dynamic-reconfigure.c
+++ b/subprojects/gst-plugins-bad/tests/examples/va/vaenc-dynamic-reconfigure.c
@@ -43,6 +43,8 @@ typedef struct
 
   gint prev_width;
   gint prev_height;
+
+  guint force_keyframe_count;
 } TestCallbackData;
 
 static gboolean
@@ -130,9 +132,10 @@ loop_rate_control (GstElement * encoder)
   g_object_set (encoder, "rate-control", enum_class->values[i].value, NULL);
 }
 
+static gboolean force_key_frame;
+
 static GstPadProbeReturn
-resolution_change_probe (GstPad * pad, GstPadProbeInfo * info,
-    gpointer user_data)
+pad_buffer_probe (GstPad * pad, GstPadProbeInfo * info, gpointer user_data)
 {
   GstPadProbeReturn ret = GST_PAD_PROBE_OK;
   TestCallbackData *data = (TestCallbackData *) user_data;
@@ -144,6 +147,17 @@ resolution_change_probe (GstPad * pad, GstPadProbeInfo * info,
     GstPad *peer = gst_pad_get_peer (pad);
     GstFlowReturn flow_ret = GST_FLOW_OK;
 
+    if (force_key_frame) {
+      GstEvent *force_key_event;
+
+      force_key_frame = FALSE;
+
+      force_key_event = gst_video_event_new_downstream_force_key_unit
+          (GST_BUFFER_PTS (buffer), GST_CLOCK_TIME_NONE,
+          GST_CLOCK_TIME_NONE, FALSE, data->force_keyframe_count++);
+      gst_pad_push_event (pad, force_key_event);
+    }
+
     ret = GST_PAD_PROBE_HANDLED;
 
     if (peer) {
@@ -208,6 +222,7 @@ print_keyboard_help (void)
     "p", "Decrease QP-P (only in CQP)"}, {
     "B", "Increase QP-B (only in CQP)"}, {
     "b", "Decrease QP-B (only in CQP)"}, {
+    "f", "Force to set a key frame"}, {
     "k", "show keyboard shortcuts"}
   };
   /* *INDENT-ON* */
@@ -418,6 +433,10 @@ keyboard_cb (gchar input, gboolean is_ascii, gpointer user_data)
           g_object_set (data->encoder, "qpb", qpb, NULL);
         break;
       }
+      case 'f':{
+        force_key_frame = TRUE;
+        break;
+      }
       default:
         break;
     }
@@ -541,7 +560,7 @@ main (gint argc, gchar ** argv)
 
   pad = gst_element_get_static_pad (capsfilter, "src");
   data.probe_id = gst_pad_add_probe (pad, GST_PAD_PROBE_TYPE_BUFFER,
-      resolution_change_probe, &data, NULL);
+      pad_buffer_probe, &data, NULL);
   gst_object_unref (pad);
   data.prev_width = width;
   data.prev_height = height;
-- 
2.25.1

